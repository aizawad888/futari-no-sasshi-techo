<% bg_class =
  case post.sense_level
  when "high" then "bg-wood-light"
  when "medium" then "bg-cream"
  when "low" then "bg-sage"
  else "bg-white"
  end %>

<%= link_to post_path(post), class: "block" do %>
  <div
    class="
      <%= bg_class %>
      flex
      rounded-xl
      shadow-md
      p-4
      mb-6
      transform rotate-1 hover:rotate-0
      transition-transform
    "
  >
    <!-- 左側 カテゴリアイコンと優先度 -->
    <div class="flex-shrink-0 mr-4 flex flex-col items-center justify-center w-16 space-y-2">
      <% if post.category&.icon.present? %>
        <%= image_tag(post.category.icon, alt: post.category.name, class: "w-8 h-8") %>
      <% end %>
      <div class="text-center text-xs text-wood-dark">
        優先度: <%= post.sense_level_jp %>
      </div>
    </div>

    <!-- 右側 -->
    <div class="flex flex-col flex-grow">

      <!-- 答え公開時の演出 -->
      <% if post.just_unlocked?(last_viewed_at) %>
        <div class="text-xs text-accent-orange mb-1">
          🔓 答えが公開されました
        </div>
      <% end %>

      <p class="text-xs text-wood-dark mb-1">
        カテゴリ: <%= post.category.name %>
      </p>

      <h3
        class="
          text-base
          font-semibold
          mb-2
          text-forest-green
          <%= 'text-accent-orange' if post.user != current_user && Time.current < post.reveal_at %>
        "
      >
        <%= post.title_for_view(current_user) %>
        <% if last_viewed_at.nil? || post.created_at > last_viewed_at %>
          <span class="ml-2 text-xs bg-accent-orange text-white px-2 py-0.5 rounded-full">
            New
          </span>
        <% end %>
      </h3>

      <% if post.reveal_at.present? && Time.current < post.reveal_at %>
        <div class="mt-auto text-xs">
          <% hours_left = ((post.reveal_at - Time.current) / 1.hour).ceil %>
          <span class="<%= 'text-red-600 font-semibold' if hours_left <= 1 %> text-wood-dark">
            答え合わせまであと <%= hours_left %>時間！
          </span>
        </div>
      <% end %>

      <!-- 下側 投稿者情報 -->
      <div class="flex items-center justify-end mt-auto text-xs text-wood-dark space-x-2">
        <% if post.user.icon.present? %>
          <%= image_tag("user_icons/#{post.user.icon}", class: "w-6 h-6 rounded-full") %>
        <% end %>
        <span><%= post.user.name %></span>
        <span>
          <%= post.created_at.in_time_zone.strftime("%Y/%m/%d %H:%M") %>
        </span>
      </div>

    </div>
  </div>
<% end %>
