<% content_for(:page_title, t('main.index')) %>
<% content_for(:show_back_button, false) %>


<div class="max-w-md mx-auto px-4 py-4 space-y-4">

  <% if @partner.nil? %>
    <p>まだペアが設定されていません。</p>
  <% else %>
    <div>
      あなた: <%= current_user.name || "名無し" %> | 
      相手: <%= @partner.name || "名無し" %>
    </div>
  <% end %>

  <!-- 検索欄（仮） -->
  <div class="flex items-center space-x-2">
    <input type="text" placeholder="投稿の検索" class="flex-1 border rounded-lg px-3 py-2 text-sm" />
    <button class="px-4 py-2 text-sm bg-gray-200 rounded-lg">検索</button>

    <%= form_with url: "#", method: :get do |f| %>
      <%= f.collection_select :category_id, Category.all, :id, :name, prompt: "カテゴリを選択…" %>
    <% end %>
  </div>

  <!-- 投稿一覧 -->
  <div id="posts-list" class="space-y-4">
    <% if @posts.any? %> <!-- 1件以上あるか？ -->
      <% @posts.each do |post| %> <!-- ループ表示 -->
        <!-- 優先度による背景色分岐 -->
        <% bg_class =
          case post.sense_level
          when "high" then "bg-red-200"
          when "medium" then "bg-yellow-200"
          when "low" then "bg-green-200"
          else "bg-gray-100"
          end %>

        <%= link_to post_path(post), class: "block" do %>
          <div class="<%= bg_class %> flex rounded-lg shadow p-4 h-32 mb-4">
            <!-- 左側: カテゴリアイコン・優先度 -->
            <div class="flex-shrink-0 mr-4 flex flex-col items-center justify-center w-16 space-y-2">
              <% if post.category&.icon.present? %>
                <%= image_tag(post.category.icon, alt: post.category.name, class: "w-8 h-8") %>
              <% end %>
              <div class="text-center text-xs text-gray-400 ">
                <span>優先度: <%= post.sense_level_jp %></span>
              </div>
            </div>

            <!-- 右側: 投稿内容 -->
            <div class="flex flex-col flex-grow h-full">
              <!-- 上: カテゴリ名 -->
              <p class="text-sm text-gray-500 mb-1">カテゴリ: <%= post.category.name %></p>

              <!-- 上: タイトル・分岐設定 -->
              <h3 class="text-lg font-semibold mb-2 <%= 'text-blue-600' if post.user != current_user && Time.current < post.reveal_at %>">
                <%= post.title_for_view(current_user) %>
              </h3>

              <!-- 上: 残り時間_残り1時間で赤字、答えが公開されてない場合のみ -->
              <% if post.reveal_at.present? && Time.current.in_time_zone < post.reveal_at.in_time_zone %>
                <div class="mt-auto text-xs space-x-2">
                  <% hours_left = ((post.reveal_at.in_time_zone - Time.current.in_time_zone) / 1.hour).ceil %>
                  <span class="<%= 'text-red-500 font-semibold' if hours_left <= 1 %>">
                    答え合わせまであと <%= hours_left %>時間！
                  </span>
                </div>
              <% end %>


              <!-- 下: 投稿者・投稿時間・残り時間 -->
              <div class="flex items-center justify-end mt-auto text-xs text-gray-400 space-x-2">
                <% if post.user.icon.present? %>
                  <%= image_tag("user_icons/#{post.user.icon}", alt: post.user.name, class: "w-6 h-6 rounded-full") %>
                <% end %>
                <span><%= post.user.name %></span>
                <span><%= post.created_at.in_time_zone.strftime("%Y/%m/%d %H:%M") %></span>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% else %>
      <div class="bg-gray-100 rounded-lg p-4 text-gray-500 text-sm">
        投稿がまだありません
      </div>
    <% end %>
  </div>

</div>

<!-- 右下の追加ボタン -->
<%= link_to new_post_path,
  class: "fixed bottom-20 right-6 w-14 h-14 bg-pink-300 text-white rounded-full shadow-lg flex items-center justify-center text-3xl" do %>
  +
<% end %>



